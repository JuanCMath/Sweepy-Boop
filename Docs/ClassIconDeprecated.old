-- https://www.wowinterface.com/downloads/info14110-BLPConverter.html
local selectionBorderPrefix = "interface\\unitpowerbaralt\\";
local selectionBorderSuffix = "_circular_frame";
local selectionBorder = {
    [addon.SELECTIONBORDERSTYLE.ARCANE] = selectionBorderPrefix .. "arcane" .. selectionBorderSuffix,
    [addon.SELECTIONBORDERSTYLE.FIRE] = selectionBorderPrefix .. "fire" .. selectionBorderSuffix,
    [addon.SELECTIONBORDERSTYLE.AIR] = selectionBorderPrefix .. "air" .. selectionBorderSuffix,
    [addon.SELECTIONBORDERSTYLE.PLAIN] = "Interface\\AddOns\\SweepyBoop\\ClassIcons\\common\\PlainBorder",
};

-- Make sure icons have about the same padding between border and actual content, otherwise the border texture might look strange (too big or too small)
local ClassIconSize = {
    Player = 64,
    Pet = 48,
};

local function GetNameplate(unitId)
    if ( not unitId ) then return end

    local nameplate = C_NamePlate.GetNamePlateForUnit(unitId, true);

    if ( not nameplate ) or ( not nameplate.UnitFrame ) then return end

    return nameplate, nameplate.UnitFrame;
end

local function OnNamePlateRemoved(unitId)
    local _, frame = GetNameplate(unitId);
    if ( not frame ) or frame:IsForbidden() then return end

    -- Undo changes by the addon
    HideWidgets(frame); -- Even in restricted areas, hide widgets we've created (we don't want to show class icons, spec icons, etc. in dungeons)
    if ( not IsRestricted() ) then
        frame:Show(); -- Restore the unit frame hidden by the addon
    end
end

local function OnNamePlateAdded(unitId)
    OnNamePlateRemoved(unitId); -- Undo previous changes

    local _, frame = GetNameplate(unitId);
    if ( not frame ) or frame:IsForbidden() or IsRestricted() then return end

    addon.UpdateClassIcon(frame);
    addon.UpdateNpcHighlight(frame);
    addon.UpdateSpecIcon(frame);

    UpdateHealthBar(frame);
end

local function TryRefreshAllNamePlates()
    if UnitAffectingCombat("player") then
        print("In combat, retry after 1s");
        C_Timer.After(1, TryRefreshAllNamePlates);
    else
        SweepyBoop:RefreshAllNamePlates();
    end
end

-- local eventFrame = CreateFrame("Frame");
    -- eventFrame:RegisterEvent(addon.NAME_PLATE_UNIT_ADDED);
    -- eventFrame:RegisterEvent(addon.NAME_PLATE_UNIT_REMOVED);
    -- -- Sometimes between solo shuffle rounds friendly nameplates show up, or nameplate is hidden but class icon is not showing
    -- -- UnitIsUnit(unitId, "party1/2") is possibly messed up at the beginning of new round
    -- -- Wait for 1s to do a full refresh on all visible nameplates
    -- eventFrame:RegisterEvent(addon.ARENA_PREP_OPPONENT_SPECIALIZATIONS);
    -- eventFrame:SetScript("OnEvent", function(_, event, unitId)
    --     if event == addon.NAME_PLATE_UNIT_ADDED then
    --         OnNamePlateAdded(unitId);
    --     elseif event == addon.NAME_PLATE_UNIT_REMOVED then
    --         OnNamePlateRemoved(unitId);
    --     else -- ARENA_PREP_OPPONENT_SPECIALIZATIONS
    --         TryRefreshAllNamePlates(); -- If in combat, retry every sec until succeeds
    --     end
    -- end)
